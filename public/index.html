
<!DOCTYPE html>
<html lang="en" ng-app="app">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="/css/loading-bar.min.css">
    <script src="/scripts/angular.min.js"></script>
    <script src="/scripts/loading-bar.min.js"></script>
    <script src="/scripts/ui-bootstrap-tpls.min.js"></script>
    <style>
    .page-header{
        background-color: rgb(206, 232, 196);
        margin: 0px;
        padding-bottom: 30px;
        padding-top: 30px;
        padding-left: 10px;
        color:rgb(60, 118, 65);
        text-align: center;
    }
    .shiftDropdown{
        width: 225px;
    }
    .alertClass{
        margin-left: 22%;
    }
    #recordAttendanceButton{
        border-top-right-radius: 4px; 
        border-bottom-right-radius: 4px; 
    }
    </style>
    <script>
    angular.module('app', ['ui.bootstrap','angular-loading-bar'])
    .config(['cfpLoadingBarProvider',function (cfpLoadingBarProvider) {
        cfpLoadingBarProvider.includeSpinner=false;
    }])
    .factory('Service', ['$http', function ($http) {

        var service={};
        service.getMembers=function () {
            return $http({
                method:'GET',
                url:'/members',
            });
        };
        service.enterAttendance=function (data) {
            return $http({
                method:'POST',
                url:'/enter',
                data:data
            });
        };
        service.getShiftDetails=function () {
            return $http({
                method:'GET',
                url:'/shiftDetails'
            });
        };

        service.authorizeRosterEdit=function (passphrase) {
            return $http({
                method:'POST',
                url:'/authorizeRosterEdit',
                data:{
                    passphrase:passphrase
                }
            })
        };

        service.getMembersInShift=function (shiftDetails) {
            return $http({
                method:'GET',
                url:'/membersInShift',
                params:{
                    shift:shiftDetails.shift,
                    year:shiftDetails.year,
                    month:shiftDetails.month,
                    day:shiftDetails.day
                }
            });
        };
        service.deleteEntry=function (shiftDetails,memberId) {
            return $http({
                method:'POST',
                url:'/deleteEntry',
                data:{
                    shift:shiftDetails.shift,
                    year:shiftDetails.year,
                    month:shiftDetails.month,
                    day:shiftDetails.day,
                    memberId:memberId
                }
            });
        };
        return service;

    }])
    .controller('attendanceRecorderController', ['$scope','$rootScope','Service', function ($scope,$rootScope,Service) {

        $scope.error='';
        $scope.successMessage='';

        Service.getMembers()
        .then(function(response){
            $scope.error='';
            $scope.members=response.data;
        },function(errorResponse){
            $scope.successMessage='';
            $scope.error=errorResponse.data;
        });

        $scope.submit=function () {
            $scope.error='';
            $scope.successMessage='';
            if ($scope.data && $scope.data.memberId && $scope.data.passphrase) {
                Service.enterAttendance($scope.data)
                .then(function(response){
                    $scope.error='';
                    console.log(response);
                    $scope.successMessage=response.data;
                    $rootScope.$broadcast('attendance-entered');
                },function(errorResponse){
                    $scope.successMessage='';
                    $scope.error=errorResponse.data;
                    console.log(errorResponse);
                });
            } 
        };

    }])
    .controller('RosterController', ['$scope','$rootScope','Service', function ($scope,$rootScope,Service) {
         
         $scope.editresetbutton="Edit Roster";
        var logResponseToConsole=function (response) {
            console.log(response.data);
        };

        var updateMembersInShift=function (shiftDetails) {
            $scope.errorMessage='';
            $scope.membersInCurrentShift=[];
            $scope.membersInPreviousShift=[];
            Service.getShiftDetails()
            .then(function (response){
                if (!shiftDetails || angular.equals(shiftDetails, response.data.currentShift)) {
                    var currentShiftDetails=response.data.currentShift;
                    var previousShiftDetails=response.data.previousShift;
                    if (!shiftDetails) {
                        $scope.date=new Date(currentShiftDetails.year,currentShiftDetails.month,currentShiftDetails.day);
                        $scope.shift=currentShiftDetails.shift;
                    } 
                    Service.getMembersInShift(currentShiftDetails)
                    .then(function (response){
                        $scope.membersInCurrentShift=response.data;
                    },logResponseToConsole);
                    if(!response.data.previousShiftEnded){
                        Service.getMembersInShift(previousShiftDetails)
                        .then(function (response){
                            $scope.membersInPreviousShift=response.data;
                        },logResponseToConsole);
                    }
                } else {
                    $scope.membersInPreviousShift=[];
                    Service.getMembersInShift(shiftDetails)
                    .then(function (response){
                        $scope.membersInCurrentShift=response.data;
                    },logResponseToConsole);
                }
            },logResponseToConsole);
        };

        updateMembersInShift();

        $scope.$watch('date', function(newDate) {
            if (newDate) {
                var shiftDetails={
                    shift:$scope.shift,
                    year:newDate.getFullYear(),
                    month:newDate.getMonth(),
                    day:newDate.getDate()
                };
                updateMembersInShift(shiftDetails);
            }
        });

        $scope.$watch('shift', function(newShift) {
            if (newShift) {
                var shiftDetails={
                    shift:newShift,
                    year:$scope.date.getFullYear(),
                    month:$scope.date.getMonth(),
                    day:$scope.date.getDate()
                };
                updateMembersInShift(shiftDetails);
            }
        });

        $rootScope.$on('attendance-entered', function(){
            updateMembersInShift();
        });

        $scope.editFuction = function(){
        if($scope.isDeleteShow){
            $scope.isDeleteShow = !$scope.isDeleteShow;
           }
        else{
            $scope.isDeleteShow= true;
          }
        };

        $scope.deleteEntry=function (memberId) {
            Service.deleteEntry({
                shift:$scope.shift,
                year:$scope.date.getFullYear(),
                month:$scope.date.getMonth(),
                day:$scope.date.getDate()
            },memberId)
            .then(function (response){
                updateMembersInShift();
            },function (errorResponse){
                $scope.errorMessage=errorResponse.data;
            });
        };

        $scope.authorizeRosterEdit=function (passphrase) {
            if($scope.editresetbutton && $scope.editresetbutton != "Reset"){
            Service.authorizeRosterEdit(passphrase)
            .then(function (response) {
                $scope.isDeleteShow = true;
                $scope.errorMessage="";
                $scope.adminPassword="";
                $scope.editresetbutton="Reset";
            },function(errorResponse){
                $scope.errorMessage=errorResponse.data;
            });  
          }  
          else{
            $scope.isDeleteShow = false;
            $scope.editresetbutton="Edit Roster"
          }   
        };

        $scope.openDatePicker = function($event) {
            $event.preventDefault();
            $event.stopPropagation();
            $scope.opened = true;
        };

        $scope.shifts=[{
            shiftNo:'S1',
            shiftTiming:'S1 - 03:00am to 12:15pm'
        },{
            shiftNo:'S2',
            shiftTiming:'S2 - 10:15am to 07:30pm'
        },{
            shiftNo:'S3',
            shiftTiming:'S3 - 07:00pm to 04:15am'
        }];

    }]);
    </script>
</head>
<body>
    <h2 class="page-header"><strong>USP Support Shift Details</strong></h2>
    <tabset class="panel panel-heading container">
        <tab heading="Roster">
            <form class="panel-body" name="frmShiftPlan" ng-controller="RosterController" ng-submit="" novalidate>
                <div class="row">
                    <div class="col-md-3">
                        <p class="input-group">
                            <input type="text" class="form-control" datepicker-popup="yyyy/MM/dd" ng-model="date" is-open="opened" ng-required="true" close-text="Close" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default" ng-click="openDatePicker($event)"><i class="glyphicon glyphicon-calendar"></i></button>
                            </span>
                        </p>
                    </div>
                    <div class="col-md-1">
                        <select ng-model="shift" ng-options="shift.shiftNo as shift.shiftTiming for shift in shifts" class="form-control shiftDropdown">
                            <option value="">Shift</option>
                        </select>
                    </div>
                    <div class="col-md-4 pull-right" ng-show="membersInCurrentShift.length">
                        <p class="input-group">
                            <input name="adminPass" type="password" class="form-control" placeholder="Enter admin passphrase" ng-model="adminPassword" ng-required="true" close-text="Close" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-info" ng-disabled="frmShiftPlan.adminPass.$error.required && editresetbutton!=='Reset' "  ng-click="authorizeRosterEdit(adminPassword)">{{editresetbutton}}</button>
                            </span>
                        </p>
                    </div>
                </div>
                <alert class="col-md-5" ng-show="!membersInCurrentShift.length && !membersInPreviousShift.length" type="info"><strong>No data available.</strong></alert>
                <accordion close-others="false" ng-show="membersInCurrentShift.length || membersInPreviousShift.length">
                    <accordion-group heading="Members in shift" is-open="true">
                        <table class="table table-striped table-condensed" ng-show="membersInCurrentShift.length">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Name</th>
                                    <th>User Name</th>
                                    <th>Tier</th>
                                    <th>Primary Module</th>
                                    <th>Secondary Module</th>
                                    <th>Phone 1</th>
                                    <th>Phone 2</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="member in membersInCurrentShift | orderBy:'name'">
                                    <td>{{member.location}}</td>
                                    <td>{{member.name}}</td>
                                    <td>{{member.username}}</td>
                                    <td>{{member.tier}}</td>
                                    <td>{{member.module1}}</td>
                                    <td>{{member.module2}}</td>
                                    <td>{{member.phone1}}</td>
                                    <td>{{member.phone2}}</td>
                                    <td>
                                        <button ng-click="deleteEntry(member._id)" ng-show="isDeleteShow" class="btn btn-sm btn-info" >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <span ng-show="!membersInCurrentShift.length">There are no members in the selected shift.</span>
                        <alert class="col-md-6 alertClass" ng-show="errorMessage" type="danger" style="text-align:center"><strong>{{errorMessage}}</strong></alert>
                    </accordion-group>
                    <accordion-group heading="Members available from previous shift" is-open="true" ng-show="membersInPreviousShift.length">
                        <table class="table table-striped table-condensed">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Name</th>
                                    <th>User Name</th>
                                    <th>Tier</th>
                                    <th>Primary Module</th>
                                    <th>Secondary Module</th>
                                    <th>Phone 1</th>
                                    <th>Phone 2</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="member in membersInPreviousShift | orderBy:'name'">
                                    <td>{{member.location}}</td>
                                    <td>{{member.name}}</td>
                                    <td>{{member.username}}</td>
                                    <td>{{member.tier}}</td>
                                    <td>{{member.module1}}</td>
                                    <td>{{member.module2}}</td>
                                    <td>{{member.phone1}}</td>
                                    <td>{{member.phone2}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </accordion-group>
                </accordian>
            </form>
        </tab>
        <tab heading="Record Attendance">
            <form class="panel-body" name="frmAttendanceRecorder" ng-controller="attendanceRecorderController"  ng-submit="submit()" novalidate>
                <div class="row">
                   <div class="col-md-3">
                        <select ng-model="data.memberId" ng-options="member._id as member.name for member in members | orderBy:'name'" name="selName" class="form-control" ng-change="error='';successMessage=''">
                            <option value=''>Select Name</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <p class="input-group">
                            <input type="password" name="pwdPassphrase" class="form-control" ng-required="true" ng-model="data.passphrase" placeholder="Enter passphrase"/>
                            <span class="input-group-btn">
                                <button id="recordAttendanceButton" ng-disabled="frmAttendanceRecorder.pwdPassphrase.$error.required" type="submit" class="btn btn-success">Record Attendance</button><br/>
                            </span>
                        </p>
                    </div>
                </div>
                <alert class="col-md-5" ng-show="successMessage" type="success"><strong>{{successMessage}}</strong></alert>
                <alert class="col-md-6" ng-show="error" type="danger"><strong>{{error}}</strong></alert>
            </form>
        </tab>
    </tabset>
</body>
</html>